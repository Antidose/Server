<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
</head>

<body>
<!--https://developers.google.com/maps/documentation/javascript/-->
<!--https://github.com/googlemaps/js-marker-clusterer-->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD0R4NEaJUmLd85A-2ymIc8daTEYFRq0mA"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<div id="map" style="height: 900px; width: 100%;"></div>

<script>

    window.onload = function() {

        var request = new XMLHttpRequest();
        request.open('GET', '/adminInfo', true);

        request.onload = function() {
            if (request.status >= 200 && request.status < 400) {
                var data = request.responseText;
                console.log(data);
                var map           = new google.maps.Map(document.getElementById('map'), {});
                var bounds        = new google.maps.LatLngBounds();
                var infoWindow    = new google.maps.InfoWindow({maxWidth: 450, maxHeight: 500});
                var markers = [];
                var marker;
                var contentString;
                var lat;
                var lng;
                var i;
                var j;
                var overlap;
                var position;
                //create the markers
                data = JSON.parse(data);
                console.log(data.Responders.length);
                console.log("<br/>");
                for (i = 0;  i < data.Responders.length; i++) {
                    lat = data.Responders[i].Latitude;
                    lng = data.Responders[i].Longitude;
                    console.log("first: " + data.Responders[i].First + " lng: "+ lng + " lng: " + lng + "<br/>");
                    position = new google.maps.LatLng(lat, lng);
                    //html for the popup info window
                    contentString = "meme"
//                    contentString =
//                        '<h4>'+data.Responders[i].First+'</h4>'+
//                        '<div style=" display: table;">'+
//                        '<div style="display: table-row">'+
//                        // '<div style="display: table-cell;"><img src="'+ items[i].thumbnail_url_ssm +'" alt ="/uploads/spotlight/resources/videoupload/url/stockaudio.jpg" height="100" width = "100"/></div>'+
//                        // '<div style="display: table-cell; vertical-align: top; padding-left: 10px;">'+ (items[i]["spotlight_upload_dc.description_tesim"] == null? "" : items[i]["spotlight_upload_dc.description_tesim"]) +'</div>'+
//                        '</div>'+
//                        '<div style="display: table-row">'+
//                        // '<div style="display: table-cell; padding-top:5px;""><a href = '+'/spotlight/' + items[i].id.split("-")[0] + '/catalog/' + items[i].id+'>View</a></div>'+
//                        // '<div style="display: table-cell; text-align: right">'+ (items[i]["spotlight_upload_dc.Coverage-Spatial.Location_ftesim"] == null? "": items[i]["spotlight_upload_dc.Coverage-Spatial.Location_ftesim"]) +'</div>'+
//                        '</div>'+
//                        '</div>';
                    marker = new google.maps.Marker({
                        map: null,
                        position: position,
                        title: data.Responders[i].First,
                        groupSize: 1,
                        text: "helo"
                    });
                    overlap = false;
                    //check if new marker overlaps with another marker
                    for(j = 0; j < markers.length; j+=1){
                        //add marker info to currenty exsting marker
                        if(position.equals(markers[j].getPosition())){
                            overlap = true;
                            markers[j].text = markers[j].text + '<hr style="border-top: 1px solid #cccccc;" />' + contentString;
                            markers[j].groupSize = markers[j].groupSize + 1;
                            if (markers[j].groupSize > 1){ markers[j].setLabel(String(markers[j].groupSize));}
                            break;
                        }
                    } //end for
                    //add marker to map if it does not overlap
                    if(!overlap){
                        marker.setMap(map);
                        bounds.extend(position); //map will zoom and move so that all markers are on the screen
                        map.fitBounds(bounds);
                        google.maps.event.addListener(marker, 'mouseover', (function (marker, i) {
                            return function () {
                                contentString = marker.text;
                                infoWindow.setContent(contentString);
                                infoWindow.open(map, marker);
                            };
                        })(marker, i));
                        markers.push(marker);
                    }

                } //end for
                google.maps.event.addListener(map, 'click',(function(marker){
                    return function(){
                        infoWindow.close();
                    };
                })(marker));
                var options = {
                    imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
                    maxZoom: 20,
                    gridSize: 20
                };

                var markerCluster = new MarkerClusterer(map, markers, options);
                if(bounds.isEmpty()){
                    map.setCenter({lat:48.463150, lng:-123.312189});
                    map.setZoom(5);
                }
            } else {
                console.log("error");
            }
        };

        request.onerror = function() {
            console.log("conerror");
            // There was a connection error of some sort
        };

        request.send();
    };
</script>
</body>
</html>